<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CN XZQH Lib Demo</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 2rem; max-width: 640px; margin: 0 auto; color: #333; }
        h1 { font-size: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        .setup-guide { background: #f0f7ff; border: 1px solid #cce5ff; padding: 10px; border-radius: 4px; font-size: 0.9em; margin-bottom: 20px; }
        select { display: block; width: 100%; padding: 10px; margin-bottom: 15px; font-size: 1rem; border: 1px solid #ddd; border-radius: 6px; }
        select:disabled { background: #f9f9f9; color: #aaa; }
        .info-card { background: #fafafa; border: 1px solid #ddd; padding: 15px; border-radius: 6px; min-height: 80px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .label { font-weight: bold; color: #666; }
        .status { font-size: 0.8rem; color: #888; text-align: right; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>ðŸ‡¨ðŸ‡³ China Administrative Divisions</h1>
    
    <div class="setup-guide">
        <p><strong>Dev Note:</strong> This demo uses <code>xzqh_loader.js</code> to wrap the low-level WASM/FlatBuffers complexity.</p>
    </div>

    <select id="sel-prov" disabled><option>Loading Library...</option></select>
    <select id="sel-city" disabled><option>Select City</option></select>
    <select id="sel-county" disabled><option>Select County</option></select>

    <div class="info-card" id="info-box">
        <div style="color:#999; text-align:center; margin-top:20px">Select a region to view details</div>
    </div>
    
    <div class="status" id="status-line">Initializing...</div>

    <!-- 1. Include the Core Engine (Generated by Emscripten) -->
    <script src="dist/xzqh_core.js"></script>
    
    <!-- 2. Include the High-Level SDK -->
    <script src="xzqh_loader.js"></script>

    <!-- 3. App Logic -->
    <script>
        let db = null;

        // Initialize Library
        (async function main() {
            try {
                // Initialize the SDK
                // Pointing to the dist folder where .wasm and .bin are located
                db = await XZQH.load({
                    dataUrl: 'dist/xzqh.bin',
                    wasmUrl: 'dist/xzqh_core.wasm'
                });

                document.getElementById('status-line').textContent = "Ready. Memory: " + (db.size/1024).toFixed(1) + " KB";
                
                // Load Provinces
                const provs = db.getProvinces();
                renderSelect('sel-prov', provs, 'Select Province');
                
            } catch (err) {
                console.error(err);
                document.getElementById('status-line').textContent = "Error: " + err.message;
                document.getElementById('status-line').style.color = "red";
            }
        })();

        // UI Helpers
        function renderSelect(id, list, placeholder) {
            const el = document.getElementById(id);
            el.innerHTML = `<option value="-1">${placeholder}</option>`;
            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.index;
                opt.text = item.name;
                el.appendChild(opt);
            });
            el.disabled = false;
        }

        function clearSelect(id, placeholder) {
            const el = document.getElementById(id);
            el.innerHTML = `<option value="-1">${placeholder}</option>`;
            el.disabled = true;
        }

        function showInfo(pIdx, cIdx, coIdx) {
            if (!db || pIdx == -1) {
                document.getElementById('info-box').innerHTML = '<div style="color:#999; text-align:center; margin-top:20px">Select a region</div>';
                return;
            }
            const info = db.getDetail(pIdx, cIdx, coIdx);
            
            let html = `
                <div class="row"><span class="label">Name:</span> <span>${info.name}</span></div>
                <div class="row"><span class="label">Code:</span> <span>${info.code}</span></div>
            `;
            
            if (info.lng) {
                html += `
                <div class="row"><span class="label">Coordinates:</span> <span>${info.lng}, ${info.lat}</span></div>
                <div style="text-align:right; margin-top:10px;">
                    <a href="https://www.amap.com/search?query=${info.lat},${info.lng}" target="_blank" style="color:#007aff; text-decoration:none; font-size:0.9em">Open in Maps &rarr;</a>
                </div>
                `;
            } else {
                html += `<div class="row"><span class="label">Coordinates:</span> <span style="color:#ccc">N/A</span></div>`;
            }
            document.getElementById('info-box').innerHTML = html;
        }

        // Events
        document.getElementById('sel-prov').addEventListener('change', (e) => {
            const idx = parseInt(e.target.value);
            clearSelect('sel-city', 'Select City');
            clearSelect('sel-county', 'Select County');
            
            if (idx !== -1) {
                const list = db.getCities(idx);
                renderSelect('sel-city', list, 'Select City');
            }
            showInfo(idx, -1, -1);
        });

        document.getElementById('sel-city').addEventListener('change', (e) => {
            const pIdx = parseInt(document.getElementById('sel-prov').value);
            const idx = parseInt(e.target.value);
            clearSelect('sel-county', 'Select County');
            
            if (idx !== -1) {
                const list = db.getCounties(pIdx, idx);
                renderSelect('sel-county', list, 'Select County');
            }
            showInfo(pIdx, idx, -1);
        });

        document.getElementById('sel-county').addEventListener('change', (e) => {
            const pIdx = parseInt(document.getElementById('sel-prov').value);
            const cIdx = parseInt(document.getElementById('sel-city').value);
            const idx = parseInt(e.target.value);
            
            showInfo(pIdx, cIdx, idx);
        });

    </script>
</body>
</html>
